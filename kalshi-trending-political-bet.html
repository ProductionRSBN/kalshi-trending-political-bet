<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalshi Trending Bet – LIVE!</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: Arial, Helvetica, sans-serif;
            color: #ffffff;
            overflow: hidden;
        }
        .ad-graphic {
            width: 546px;
            height: 658px;
            background: linear-gradient(135deg, #003221 0%, #001a0f 100%);
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            padding: 20px 16px;
        }
        .ad-graphic::before {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.48);
            z-index: 0;
        }
        .content-wrapper {
            position: relative;
            z-index: 1;
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .header {
            text-align: center;
        }
        .header img {
            width: 200px;
            height: auto;
            margin-bottom: 8px;
        }
        .header h2 {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #09C285;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        .nav-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: #fff;
            font-size: 16px;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .nav-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        .event-image-container {
            text-align: center;
            margin: 8px 0;
        }
        #event-image {
            max-width: 100%;
            max-height: 140px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            object-fit: contain;
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        .main-title {
            font-size: 28px;
            font-weight: 900;
            text-align: center;
            margin: 8px 0;
            line-height: 1.1;
            color: #ffffff;
            text-shadow: 0 2px 6px rgba(0,0,0,0.7);
            animation: fadeIn 0.5s ease-in;
        }
        .prices {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin: 12px 0;
        }
        .price-box {
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(4px);
            padding: 12px 24px;
            border-radius: 16px;
            min-width: 100px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.18);
            animation: popIn 0.4s ease-out;
        }
        .price-box h3 {
            margin: 0 0 4px;
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
        }
        .price-box.yes h3 { color: #265CFF; }
        .price-box.no h3  { color: #AA00FF; }
        .price-box p {
            margin: 0;
            font-size: 42px;
            font-weight: 900;
            line-height: 1;
            color: #ffffff;
        }
        .volume {
            text-align: center;
            font-size: 16px;
            opacity: 0.9;
            margin: 8px 0;
            animation: fadeIn 0.5s ease-in;
        }
        #chart-container {
            height: 220px;
            margin: 12px 0;
            animation: slideUp 0.6s ease-in;
        }
        .cta {
            background: #FF6B00;
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            padding: 14px 18px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 6px 20px rgba(255,107,0,0.45);
            margin-top: auto;
            animation: fadeIn 0.5s ease-in;
        }
        .cta span {
            font-size: 24px;
            margin-left: 8px;
        }
        .error, .loading {
            text-align: center;
            font-size: 18px;
            padding: 30px 18px;
            color: #ffcc00;
        }
        .fallback-note {
            font-size: 13px;
            color: #09C285;
            margin-top: 6px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="ad-graphic">
        <div class="content-wrapper">
            <div class="header">
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/ee/Kalshi_logo.svg" alt="Kalshi" 
                     onerror="this.src=''; this.alt='Kalshi';">
                <h2>Trending Political Market RIGHT NOW</h2>
            </div>

            <div class="navigation">
                <button class="nav-btn" id="prev-btn">&lt; Prev</button>
                <button class="nav-btn" id="next-btn">Next &gt;</button>
            </div>

            <div id="main-content">
                <div class="event-image-container">
                    <img id="event-image" alt="Event Visual" onload="this.style.display='block';" onerror="this.style.display='none';">
                </div>
                <h1 class="main-title">Loading Hot Bet...</h1>
                <div class="prices" id="prices">
                    <div class="price-box yes"><h3>YES</h3><p>--¢</p></div>
                    <div class="price-box no"><h3>NO</h3><p>--¢</p></div>
                </div>
                <p class="volume">24h Volume: -- contracts<br>Last updated: --</p>
                <div id="chart-container">
                    <canvas id="price-chart"></canvas>
                </div>
            </div>

            <div class="cta">TRADE NOW on Kalshi – Predict & Profit!<span>→</span></div>
        </div>
    </div>

<script>
    const BASE_API = 'https://api.elections.kalshi.com/trade-api/v2/';
    const PROXY = 'https://api.allorigins.win/raw?url=';
    const EVENTS_URL = PROXY + encodeURIComponent(BASE_API + 'events?limit=200&with_nested_markets=true&status=open');
    const CACHE_KEY = 'kalshi_top_markets';
    const CACHE_EXPIRY = 3600000; // 1 hour
    const TOP_N = 10; // Top 10 markets to cycle through

    let topMarkets = [];
    let currentIndex = 0;
    let chartInstance = null;

    function displayMarket(index) {
        const { market, eventImageUrl, isFallback, timestamp } = topMarkets[index] || {};
        if (!market) return;

        document.querySelector('.main-title').textContent = market.title_short || market.title || 'HOT MARKET';
        
        const yesPrice = market.yes_bid ?? market.last_price ?? '--';
        const noPrice = market.no_bid ?? (market.last_price ? (100 - market.last_price) : '--');
        document.querySelector('.price-box.yes p').textContent = `${yesPrice}¢`;
        document.querySelector('.price-box.no p').textContent = `${noPrice}¢`;
        
        const volume = (market.volume_24h ?? market.volume ?? 0).toLocaleString();
        let volText = `24h Volume: ${volume} contracts<br>Last updated: ${new Date(timestamp).toLocaleTimeString([], {timeStyle: 'short'})}`;
        if (isFallback) {
            volText += `<br><span class="fallback-note">(Top volume – Politics preferred)</span>`;
        }
        document.querySelector('.volume').innerHTML = volText;

        const imgEl = document.getElementById('event-image');
        if (eventImageUrl) {
            imgEl.src = eventImageUrl.startsWith('http') ? eventImageUrl : 'https://kalshi.com' + eventImageUrl;
            imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
        }

        // Fetch and display chart
        fetchMarketHistory(market);
    }

    async function fetchMarketHistory(market) {
        try {
            // First, get series_ticker if not present
            let seriesTicker = market.series_ticker;
            if (!seriesTicker) {
                const marketUrl = PROXY + encodeURIComponent(BASE_API + `markets/${market.ticker}`);
                const marketData = await fetchJson(marketUrl);
                seriesTicker = marketData.market?.series_ticker;
            }

            if (!seriesTicker) throw new Error('No series ticker');

            // Set timestamps: last 30 days, daily candles
            const now = Math.floor(Date.now() / 1000);
            const start = now - (30 * 24 * 3600);
            const historyUrl = PROXY + encodeURIComponent(
                BASE_API + `series/${seriesTicker}/markets/${market.ticker}/candlesticks` +
                `?start_ts=${start}&end_ts=${now}&period_interval=1440&include_latest_before_start=true`
            );

            const data = await fetchJson(historyUrl);
            const candlesticks = data.candlesticks || [];

            // Prepare chart data: use price.close for line chart
            const labels = candlesticks.map(c => new Date(c.end_period_ts * 1000).toLocaleDateString());
            const prices = candlesticks.map(c => c.price?.close ?? null);

            // Destroy old chart
            if (chartInstance) chartInstance.destroy();

            const ctx = document.getElementById('price-chart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Price (¢)',
                        data: prices,
                        borderColor: '#09C285',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, max: 100, title: { display: true, text: 'Price (¢)', color: '#fff' } },
                        x: { title: { display: true, text: 'Date', color: '#fff' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } },
                    animation: { duration: 1000 }
                }
            });
        } catch (err) {
            console.error('Chart error:', err);
            document.getElementById('chart-container').innerHTML = '<p style="text-align:center;color:#ffcc00;">Chart unavailable</p>';
        }
    }

    function loadCachedData() {
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
            try {
                const data = JSON.parse(cached);
                if (Date.now() - data.timestamp < CACHE_EXPIRY) {
                    topMarkets = data.topMarkets;
                    currentIndex = 0;
                    displayMarket(currentIndex);
                    return true;
                }
            } catch (e) {}
        }
        return false;
    }

    function saveToCache() {
        localStorage.setItem(CACHE_KEY, JSON.stringify({
            topMarkets,
            timestamp: Date.now()
        }));
    }

    async function fetchJson(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(res.status);
        return res.json();
    }

    async function fetchWithRetry(url, retries = 3, delay = 1200) {
        for (let i = 0; i < retries; i++) {
            try {
                return await fetchJson(url);
            } catch (err) {
                if (i === retries - 1) throw err;
                await new Promise(r => setTimeout(r, delay * (i + 1)));
            }
        }
    }

    async function fetchTopMarkets() {
        try {
            const data = await fetchWithRetry(EVENTS_URL);
            let allMarkets = [];
            let politics = false;

            (data.events || []).forEach(ev => {
                const isPolitics = (ev.category || '').toLowerCase().includes('politics');
                if (isPolitics) politics = true;
                (ev.markets || []).forEach(m => {
                    m.event_ticker = ev.event_ticker; // Store for image
                    m.series_ticker = ev.series_ticker || ''; // If available
                    m.volume_sort = m.volume_24h ?? m.volume ?? 0;
                    allMarkets.push({ market: m, event: ev, isPolitics });
                });
            });

            // Sort: prefer politics, then by volume desc
            allMarkets.sort((a, b) => {
                if (a.isPolitics !== b.isPolitics) return b.isPolitics ? 1 : -1;
                return b.market.volume_sort - a.market.volume_sort;
            });

            // Take top N, fetch images
            topMarkets = [];
            for (let i = 0; i < Math.min(TOP_N, allMarkets.length); i++) {
                const { market, event, isPolitics } = allMarkets[i];
                let eventImageUrl = event.image_url || '';

                if (!eventImageUrl) {
                    const eventUrl = PROXY + encodeURIComponent(BASE_API + `events/${market.event_ticker}`);
                    const eventData = await fetchWithRetry(eventUrl).catch(() => ({}));
                    eventImageUrl = eventData.event?.image_url || '';
                }

                topMarkets.push({
                    market,
                    eventImageUrl,
                    isFallback: !politics && !isPolitics, // If no politics at all or this isn't
                    timestamp: Date.now()
                });
            }

            if (topMarkets.length > 0) {
                currentIndex = 0;
                displayMarket(currentIndex);
                saveToCache();
            } else {
                document.getElementById('main-content').innerHTML = '<p class="error">No active markets found – check Kalshi.com!</p>';
            }
        } catch (err) {
            console.error(err);
            if (!loadCachedData()) {
                document.getElementById('main-content').innerHTML = '<p class="error">Data temporarily unavailable – visit Kalshi!</p>';
            }
        }
    }

    // Navigation
    document.getElementById('prev-btn').addEventListener('click', () => {
        currentIndex = (currentIndex - 1 + topMarkets.length) % topMarkets.length;
        displayMarket(currentIndex);
    });
    document.getElementById('next-btn').addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % topMarkets.length;
        displayMarket(currentIndex);
    });

    // Start
    loadCachedData() || (document.querySelector('.main-title').textContent = 'Finding hottest bets...');
    fetchTopMarkets();
    setInterval(fetchTopMarkets, 300000); // 5 min
</script>
</body>
</html>
