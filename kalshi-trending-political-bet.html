<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalshi Trending Political Bet</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent; /* For Wirecast overlay */
            font-family: Arial, sans-serif;
            color: #fff;
        }
        .graphic {
            width: var(--graphic-width, 500px);
            height: calc(var(--graphic-width) * 1.2); /* 5:6 ratio */
            background: linear-gradient(to bottom, #0a0a0a, #1a1a1a);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }
        .header {
            text-align: center;
        }
        .header img {
            width: 180px;
        }
        .content {
            text-align: center;
        }
        .title {
            font-size: 24px;
            margin: 10px 0;
        }
        .prices {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .price-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
        }
        .price-box h3 {
            margin: 0;
            font-size: 18px;
        }
        .price-box p {
            margin: 5px 0 0;
            font-size: 32px;
            font-weight: bold;
        }
        .volume {
            font-size: 16px;
            opacity: 0.8;
        }
        .cta {
            text-align: center;
            font-size: 18px;
            background: #ff6b00; /* Kalshi orange-ish */
            padding: 10px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .error {
            text-align: center;
            font-size: 18px;
            color: #ff0000;
        }
        .fallback-note {
            font-size: 14px;
            color: #ffff00;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="graphic" id="graphic">
        <div class="header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/ee/Kalshi_logo.svg" alt="Kalshi Logo" onerror="this.alt='Kalshi'; this.src=''; this.nextSibling.textContent='Kalshi';">
            <h2>Trending US Political Bet Today</h2>
        </div>
        <div class="content" id="content">
            <h1 class="title">Loading...</h1>
            <div class="prices">
                <div class="price-box"><h3>Yes</h3><p>--¢</p></div>
                <div class="price-box"><h3>No</h3><p>--¢</p></div>
            </div>
            <p class="volume">24h Volume: --</p>
        </div>
        <div class="cta">Bet on Real Events with Kalshi – Your Prediction Market Sponsor!</div>
    </div>

    <script>
        const TARGET_URL = 'https://api.elections.kalshi.com/trade-api/v2/events?limit=200&with_nested_markets=true&status=open';
        const API_URL = 'https://corsproxy.io/?' + encodeURIComponent(TARGET_URL);
        const CACHE_KEY = 'kalshi_trending_data';
        const CACHE_EXPIRY = 3600000; // 1 hour in ms

        // Function to display market data
        function displayMarket(market, isFallback = false, timestamp = new Date()) {
            if (!market) return;
            document.querySelector('.title').textContent = market.title_short || market.title || 'N/A';
            const yesPrice = market.yes_bid ?? market.last_price ?? '--';
            const noPrice = market.no_bid ?? (100 - (market.last_price ?? 0)) ?? '--'; // Fallback to inverse if no_bid missing
            document.querySelector('.prices .price-box:nth-child(1) p').textContent = `${yesPrice}¢`;
            document.querySelector('.prices .price-box:nth-child(2) p').textContent = `${noPrice}¢`;
            const volume = (market.volume_24h ?? 0).toLocaleString();
            let volumeText = `24h Volume: ${volume} contracts`;
            volumeText += `<br>Last updated: ${timestamp.toLocaleTimeString()}`;
            if (isFallback) {
                volumeText += `<br><span class="fallback-note">(Fallback: Highest volume market overall)</span>`;
            }
            document.querySelector('.volume').innerHTML = volumeText;
        }

        // Load from cache
        function loadCachedData() {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const { market, isFallback, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp < CACHE_EXPIRY) {
                    displayMarket(market, isFallback, new Date(timestamp));
                    return true;
                } else {
                    localStorage.removeItem(CACHE_KEY); // Expire old cache
                }
            }
            return false;
        }

        // Save to cache
        function saveToCache(market, isFallback) {
            const data = { market, isFallback, timestamp: Date.now() };
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        }

        // Fetch with retry
        async function fetchWithRetry(url, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error(`Fetch attempt ${i+1} failed: ${error}`);
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i))); // Exponential backoff
                }
            }
        }

        async function fetchTrendingBet() {
            try {
                const data = await fetchWithRetry(API_URL);
                
                let trendingMarket = null;
                let maxVolume = 0;
                let politicsFound = false;

                data.events.forEach(event => {
                    const category = event.category.toLowerCase();
                    if (category === 'politics') politicsFound = true;
                    event.markets.forEach(market => {
                        const vol = market.volume_24h || 0;
                        if (vol > maxVolume) {
                            maxVolume = vol;
                            trendingMarket = market;
                        }
                    });
                });

                if (trendingMarket) {
                    const isFallback = !politicsFound;
                    displayMarket(trendingMarket, isFallback);
                    saveToCache(trendingMarket, isFallback);
                } else {
                    document.querySelector('#content').innerHTML = '<p class="error">No active markets found today.</p>';
                }
            } catch (error) {
                console.error('Final fetch error:', error);
                document.querySelector('#content').innerHTML = '<p class="error">API temporarily unavailable. Using cached data if available.</p>';
                if (!loadCachedData()) {
                    document.querySelector('#content').innerHTML = '<p class="error">Error loading data. Please try again later.</p>';
                }
            }
        }

        // Initial load: Show cache first, then fetch
        if (!loadCachedData()) {
            document.querySelector('.title').textContent = 'Loading...';
        }
        fetchTrendingBet();

        // Auto-update every 5 minutes
        setInterval(fetchTrendingBet, 300000);
    </script>
</body>
</html>

