<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalshi Trending Bet – LIVE!</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: Arial, Helvetica, sans-serif;
            color: #ffffff;
            overflow: hidden;
        }
        .ad-graphic {
            width: 546px;
            height: 658px;
            background: linear-gradient(135deg, #003221 0%, #001a0f 100%);
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            padding: 24px 20px;
        }
        .ad-graphic::before {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.48);
            z-index: 0;
        }
        .content-wrapper {
            position: relative;
            z-index: 1;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }
        .header {
            text-align: center;
        }
        .header img {
            width: 220px;
            height: auto;
            margin-bottom: 12px;
        }
        .header h2 {
            font-size: 22px;
            font-weight: bold;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #09C285;
        }
        .event-image-container {
            text-align: center;
            margin: 12px 0 18px;
        }
        #event-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            object-fit: contain;
            display: none; /* hidden until loaded */
        }
        .main-title {
            font-size: 32px;
            font-weight: 900;
            text-align: center;
            margin: 12px 0 8px;
            line-height: 1.1;
            color: #ffffff;
            text-shadow: 0 2px 6px rgba(0,0,0,0.7);
        }
        .prices {
            display: flex;
            justify-content: center;
            gap: 28px;
            margin: 20px 0 16px;
        }
        .price-box {
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(4px);
            padding: 14px 28px;
            border-radius: 16px;
            min-width: 110px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.18);
        }
        .price-box h3 {
            margin: 0 0 6px;
            font-size: 20px;
            font-weight: bold;
            color: #ffffff;
        }
        .price-box.yes h3 { color: #265CFF; }
        .price-box.no h3  { color: #AA00FF; }
        .price-box p {
            margin: 0;
            font-size: 48px;
            font-weight: 900;
            line-height: 1;
            color: #ffffff;
        }
        .volume {
            text-align: center;
            font-size: 17px;
            opacity: 0.9;
            margin: 10px 0 24px;
        }
        .cta {
            background: #FF6B00;
            color: #fff;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            padding: 16px 20px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 6px 20px rgba(255,107,0,0.45);
            margin-top: auto;
        }
        .cta span {
            font-size: 26px;
            margin-left: 8px;
        }
        .error, .loading {
            text-align: center;
            font-size: 20px;
            padding: 40px 20px;
            color: #ffcc00;
        }
        .fallback-note {
            font-size: 14px;
            color: #09C285;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="ad-graphic">
        <div class="content-wrapper">
            <div class="header">
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/ee/Kalshi_logo.svg" alt="Kalshi" 
                     onerror="this.src=''; this.alt='Kalshi';">
                <h2>Trending Political Market RIGHT NOW</h2>
            </div>

            <div id="main-content">
                <div class="event-image-container">
                    <img id="event-image" alt="Event Visual" onload="this.style.display='block';" onerror="this.style.display='none';">
                </div>
                <h1 class="main-title">Loading Hot Bet...</h1>
                <div class="prices" id="prices">
                    <div class="price-box yes"><h3>YES</h3><p>--¢</p></div>
                    <div class="price-box no"><h3>NO</h3><p>--¢</p></div>
                </div>
                <p class="volume">24h Volume: -- contracts<br>Last updated: --</p>
            </div>

            <div class="cta">TRADE NOW on Kalshi – Predict & Profit!<span>→</span></div>
        </div>
    </div>

<script>
    const BASE_API = 'https://api.elections.kalshi.com/trade-api/v2/';
    const PROXY = 'https://api.allorigins.win/raw?url=';
    const EVENTS_URL = PROXY + encodeURIComponent(BASE_API + 'events?limit=200&with_nested_markets=true&status=open');
    const CACHE_KEY = 'kalshi_trending_ad';
    const CACHE_EXPIRY = 3600000; // 1 hour

    function displayMarket(market, eventImageUrl = '', isFallback = false, timestamp = new Date()) {
        if (!market) return;
        document.querySelector('.main-title').textContent = market.title_short || market.title || 'HOT MARKET';
        
        const yesPrice = market.yes_bid ?? market.last_price ?? '--';
        const noPrice = market.no_bid ?? (market.last_price ? (100 - market.last_price) : '--');
        document.querySelector('.price-box.yes p').textContent = `${yesPrice}¢`;
        document.querySelector('.price-box.no p').textContent = `${noPrice}¢`;
        
        const volume = (market.volume_24h ?? market.volume ?? 0).toLocaleString();
        let volText = `24h Volume: ${volume} contracts<br>Last updated: ${timestamp.toLocaleTimeString([], {timeStyle: 'short'})}`;
        if (isFallback) {
            volText += `<br><span class="fallback-note">(Top volume – Politics preferred)</span>`;
        }
        document.querySelector('.volume').innerHTML = volText;

        // Set event image
        const imgEl = document.getElementById('event-image');
        if (eventImageUrl) {
            imgEl.src = eventImageUrl.startsWith('http') ? eventImageUrl : 'https://kalshi.com' + eventImageUrl; // in case relative
            imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
        }
    }

    function loadCachedData() {
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
            try {
                const { market, eventImageUrl, isFallback, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp < CACHE_EXPIRY) {
                    displayMarket(market, eventImageUrl, isFallback, new Date(timestamp));
                    return true;
                }
            } catch (e) {}
        }
        return false;
    }

    function saveToCache(market, eventImageUrl, isFallback) {
        localStorage.setItem(CACHE_KEY, JSON.stringify({
            market, eventImageUrl, isFallback, timestamp: Date.now()
        }));
    }

    async function fetchJson(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(res.status);
        return res.json();
    }

    async function fetchWithRetry(url, retries = 3, delay = 1200) {
        for (let i = 0; i < retries; i++) {
            try {
                return await fetchJson(url);
            } catch (err) {
                if (i === retries - 1) throw err;
                await new Promise(r => setTimeout(r, delay * (i + 1)));
            }
        }
    }

    async function fetchTrendingBet() {
        try {
            const data = await fetchWithRetry(EVENTS_URL);
            let trending = null;
            let maxVol = 0;
            let politics = false;
            let selectedEventTicker = null;

            (data.events || []).forEach(ev => {
                if ((ev.category || '').toLowerCase().includes('politics')) politics = true;
                (ev.markets || []).forEach(m => {
                    const v = m.volume_24h ?? m.volume ?? 0;
                    if (v > maxVol) {
                        maxVol = v;
                        trending = m;
                        selectedEventTicker = ev.event_ticker;
                    }
                });
            });

            if (trending && selectedEventTicker) {
                // Fetch event details for image
                const eventUrl = PROXY + encodeURIComponent(BASE_API + `events/${selectedEventTicker}`);
                const eventData = await fetchWithRetry(eventUrl).catch(() => ({}));
                const eventImageUrl = eventData.event?.image_url || '';

                const fallback = !politics;
                displayMarket(trending, eventImageUrl, fallback);
                saveToCache(trending, eventImageUrl, fallback);
            } else {
                document.getElementById('main-content').innerHTML = '<p class="error">No active markets found – check Kalshi.com!</p>';
            }
        } catch (err) {
            console.error(err);
            if (!loadCachedData()) {
                document.getElementById('main-content').innerHTML = '<p class="error">Data temporarily unavailable – visit Kalshi!</p>';
            }
        }
    }

    // Start
    loadCachedData() || (document.querySelector('.main-title').textContent = 'Finding the hottest bet...');
    fetchTrendingBet();
    setInterval(fetchTrendingBet, 300000); // 5 min refresh
</script>
</body>
</html>
